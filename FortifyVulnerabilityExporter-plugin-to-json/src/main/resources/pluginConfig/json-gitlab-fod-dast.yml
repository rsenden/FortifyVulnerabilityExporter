---
spring.config.activate.on-loader-plugin: fod

json.gitlab.dast.filter.expr: vuln.scantype=='Dynamic'
json.gitlab.dast.format:
  fields:
    schema: https://gitlab.com/gitlab-org/security-products/security-report-schemas/-/raw/v14.0.0/dist/dast-report-format.json
    version: 14.0.0
    scan:
      start_time: $[#formatDateTime("yyyy-MM-dd'T'HH:mm:ss", release.dynamicScanSummary?.startedDateTime?:'1970-01-01T00:00:00')]
      end_time: $[#formatDateTime("yyyy-MM-dd'T'HH:mm:ss", release.dynamicScanSummary?.completedDateTime?:'1970-01-01T00:00:00')]
      status: $[release.dynamicAnalysisStatusTypeId==2?'success':'failure']
      type: dast
      scanner:
        id: FoD
        name: Fortify on Demand
        url: https://www.microfocus.com/en-us/products/application-security-testing/overview
        version: WebInspect $[release.dynamicScanSummary?.scanToolVersion?:'version unknown']
        vendor: 
          name: Fortify
      scanned_resources: |-
        $[ 
          release.siteTree==null ? {}
            : release.siteTree.![{
              method: method,
              url: scheme+'://'+host+':'+port+path,
              type: 'url' 
            }] 
        ] 
    vulnerabilities: $[vulnerabilityMappers.vulnerability.get()]
    # remediations: ...
  vulnerabilityMappers.vulnerability.fields:
    id: $[vuln.vulnId]
    category: dast
    name: $[vuln.category]
    message: $[vuln.category]
    description: $[#htmlToText(vuln.details?.summary)]
    cve: $[vuln.instanceId]
    severity: $[{'Critical':'Critical','High':'High','Medium':'Medium','Low':'Low','Best Practice':'Info','Info':'Info'}.get(vuln.severityString)?:'Unknown']
    confidence: $[(vuln.severityString matches "(Critical|Medium)") ? "High":"Low" ]
    solution: |-
      $[#htmlToText(vuln.details?.explanation)]
      
      $[#htmlToText(vuln.recommendations?.recommendations)]
    scanner:
      id: FoD
      name: Fortify on Demand
    identifiers: |-
      $[
        #merge(
          {
            {
              name:  "Instance id: "+vuln.instanceId,
              url:   vuln.deepLink,
              type:  "issueInstanceId",
              value: vuln.instanceId
            }
          },
          vuln.complianceItems.![{
            name: categoryName+': '+complianceRule,
            type: categoryName.replaceAll("\s+","").toLowerCase(),
            value: complianceRule 
          }]
        )
      ]
    links:
      - name: Additional issue details, including analysis trace, in Fortify on Demand
        url:  $[vuln.deepLink]
    # evidence: # TODO
    #   source:
    #     id:
    #     name:
    #     url:
    #   summary:
    #   request:
    #     headers:
    #       - name:
    #         value:
    #     method:
    #     url:
    #     body:
    #   response:
    #     headers:
    #       - name:
    #         value:
    #     reason_phrase: OK|Internal Server Error|...
    #     status_code: 200|500|...
    #     body:
    #   supporting_messages:
    #     - name:
    #       request: ...
    #       response: ...
    location:
      hostname: $[#uriPart(vuln.primaryLocationFull, 'serverUrl')?:'']
      method: $[#substringBefore(vuln.request_response?.requestContent,' ')?:'']
      param: $[#uriPart(vuln.primaryLocationFull, 'query')?:'']
      path: $[#uriPart(vuln.primaryLocationFull, 'path')?:'']
    # assets:
    #   - type: http_session|postman
    #     name: 
    #     url: link to asset in build artifacts
    # discovered_at: 2020-01-28T03:26:02.956
    
    
    