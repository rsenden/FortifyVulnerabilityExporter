# TODO: 
#   - Add tool.driver.version

---
spring.config.activate.on-loader-plugin: ssc

json.github.sast.filter.expr: vuln.engineType=='SCA'
json.github.sast.format: 
  fields:
    "[$schema]": https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json 
    version: '2.1.0'
    runs:
      - tool:
          driver:
            name: 'Fortify SCA'   
            version: $[applicationVersion.currentStaticScan?.engineVersion?:'unknown']
            rules: $[vulnerabilityMappers.rules.get()]
        results: $[#check(vulnerabilityMappers.result.get().size()>1000, "GitHub does not support importing more than 1000 vulnerabilities. Please clean the scan results or update vulnerability search criteria.")?vulnerabilityMappers.result.get():{}]
  vulnerabilityMappers:
    rules.fields:
      id: $[vuln.id+'']
      shortDescription.text: $[vuln.issueName]
      fullDescription.text: $[vuln.details?.brief]
      help:
        text: $[#htmlToText(vuln.details?.detail)+'\n\n'+#htmlToText(vuln.details?.recommendation)+"\n\nFor more information, see "+vuln.deepLink]
      properties:
        tags: $[{vuln.friority}]
        precision: $[(vuln.friority matches "(Critical|Medium)") ? "high":"low" ]
    result.fields:
      ruleId: $[vuln.id+'']
      message: 
        text: $[vuln.details?.brief]
      level: $[(vuln.friority matches "(Critical|High)") ? "warning":"note" ]
      partialFingerprints:
        issueInstanceId: $[vuln.issueInstanceId]
      locations:
        - physicalLocation:
            artifactLocation:
              uri: $[vuln.fullFileName]
            region:
              startLine: $[vuln.lineNumber==0?1:vuln.lineNumber]
              endLine: $[vuln.lineNumber==0?1:vuln.lineNumber]
              startColumn: $[1]  # Needs to be specified as an expression in order to end up as integer instead of string in JSON
              endColumn: $[80]
            